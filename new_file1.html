<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>星空穿越效果 - WarpDrive</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      height: 100%;
      width: 100%;
    }
    #warp {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="warp"></div>

  <script>
    /* === WarpDrive 类完整代码开始 === */
    class WarpDrive {
      constructor(container, options = {}) {
        this.container = container;
        this.options = Object.assign({
          width: container.clientWidth,
          height: container.clientHeight,
          starCount: 2000,
          starBgCount: 1000,
          starSpeedMax: 0.05,
          starWarpLineLength: 2,
          starWarpTunnelDiameter: 200,
          autoResize: false,
        }, options);

        this.width = this.options.width;
        this.height = this.options.height;
        this.centerX = this.width / 2;
        this.centerY = this.height / 2;

        this.paused = false;
        this.stars = [];
        this.starsBg = [];
        this.colorLookupTable = [];

        this.mouseX = this.centerX;
        this.mouseY = this.centerY;
        this.touching = false;
        this.mouseMoveTriggered = false;

        this.initCanvas();
        this.initStars();
        this.initEvents();
        this.initColorLookupTable();
        this.animate();
      }

      initCanvas() {
        this.canvas = document.createElement('canvas');
        this.canvas.width = this.width;
        this.canvas.height = this.height;
        this.ctx = this.canvas.getContext('2d');
        this.container.appendChild(this.canvas);
      }

      initStars() {
        for (let i = 0; i < this.options.starCount; i++) {
          this.stars.push(this.createStar());
        }
        for (let i = 0; i < this.options.starBgCount; i++) {
          this.starsBg.push(this.createStar(true));
        }
      }

      initColorLookupTable() {
        for (let i = 0; i < 256; i++) {
          this.colorLookupTable[i] = `rgba(${i},${i},${i},1)`;
        }
      }

      initEvents() {
        if (this.options.autoResize) {
          window.addEventListener('resize', () => {
            this.width = this.container.clientWidth;
            this.height = this.container.clientHeight;
            this.canvas.width = this.width;
            this.canvas.height = this.height;
            this.centerX = this.width / 2;
            this.centerY = this.height / 2;
          });
        }

        this.canvas.addEventListener('mousemove', e => {
          this.mouseX = e.clientX;
          this.mouseY = e.clientY;
          this.mouseMoveTriggered = true;
        });

        this.canvas.addEventListener('touchstart', e => {
          this.touching = true;
          this.mouseX = e.touches[0].clientX;
          this.mouseY = e.touches[0].clientY;
        });

        this.canvas.addEventListener('touchmove', e => {
          this.mouseX = e.touches[0].clientX;
          this.mouseY = e.touches[0].clientY;
        });

        this.canvas.addEventListener('touchend', () => {
          this.touching = false;
        });
      }

      createStar(isBackground = false) {
        return {
          x: Math.random() * this.width,
          y: Math.random() * this.height,
          z: Math.random() * this.width,
          speed: isBackground ? Math.random() * 0.01 : Math.random() * this.options.starSpeedMax,
          isBackground,
        };
      }

      resetStar(star) {
        star.x = Math.random() * this.width;
        star.y = Math.random() * this.height;
        star.z = this.width;
      }

      animate() {
        if (!this.paused) {
          this.render();
        }
        requestAnimationFrame(() => this.animate());
      }

      render() {
        this.ctx.fillStyle = 'black';
        this.ctx.fillRect(0, 0, this.width, this.height);

        for (let i = 0; i < this.starsBg.length; i++) {
          this.drawStar(this.starsBg[i]);
        }

        for (let i = 0; i < this.stars.length; i++) {
          this.drawStar(this.stars[i]);
        }
      }

      drawStar(star) {
        star.z -= star.speed;
        if (star.z <= 0) {
          this.resetStar(star);
        }

        let k = 128.0 / star.z;
        let x = (star.x - this.centerX) * k + this.centerX;
        let y = (star.y - this.centerY) * k + this.centerY;

        if (x < 0 || x >= this.width || y < 0 || y >= this.height) {
          this.resetStar(star);
          return;
        }

        let size = (1 - star.z / this.width) * (star.isBackground ? 1 : 3);
        let shade = Math.floor((1 - star.z / this.width) * 255);

        this.ctx.fillStyle = this.colorLookupTable[shade];
        this.ctx.beginPath();
        this.ctx.arc(x, y, size, 0, Math.PI * 2);
        this.ctx.fill();

        if (!star.isBackground) {
          this.ctx.strokeStyle = this.colorLookupTable[shade];
          this.ctx.beginPath();
          this.ctx.moveTo(x, y);
          this.ctx.lineTo(x + (this.centerX - x) * this.options.starWarpLineLength / 10,
                          y + (this.centerY - y) * this.options.starWarpLineLength / 10);
          this.ctx.stroke();
        }
      }

      pause() {
        this.paused = true;
      }

      unpause() {
        this.paused = false;
      }
    }
    /* === WarpDrive 类完整代码结束 === */
  </script>

  <script>
    // 初始化 WarpDrive
    const warp = new WarpDrive(document.getElementById("warp"), {
      width: window.innerWidth,
      height: window.innerHeight,
      autoResize: true,
      starCount: 2500,
      starBgCount: 800,
      starSpeedMax: 0.2,
      starWarpLineLength: 4,
      starWarpTunnelDiameter: 100,
    });

    // 按 ESC 键暂停/继续
    window.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        if (warp.paused) {
          warp.unpause();
        } else {
          warp.pause();
        }
      }
    });
  </script>
</body>
</html>
